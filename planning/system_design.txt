================================================================================
PROJECT SPECIFICATION: JUDGE
================================================================================

1. OVERVIEW
--------------------------------------------------------------------------------
A self-hosted competitive programming platform for ~50 users.
Key Features: Web Interface, Persistent Auth, Buffered Concurrency (High Capacity).
Language: Go (Server) + HTML Templates (Frontend).
Hosting Policy: MUST run on Personal Network (Home/VPS). NOT on University Network.

2. THE ARCHITECTURE
--------------------------------------------------------------------------------
[User's Browser]                        [Your Home Server]
+------------------+                    +---------------------------+
|                                       |
| --(HTTPS / 443)--> | Cloudflare Tunnel | --(HTTPS)--> | Go Web Server (:8443) |
|                    |                  +-------------+-------------+
(Zero Trust Auth)    |                                |
                     |                                v
                     |                  +---------------------------+
                     |                  |                           |
                     |                  | SQLite Database (Meta)    |
                     | + File System (Source)    |
                     |                  +-------------+-------------+
                     |                                |
                     |                                v
                     |                  +---------------------------+
                     |                  |                           |
                     |                  | Buffered Channel (RAM)    |
                     |                  | *Size: 5000 Slots         |
                     |                  +-------------+-------------+
                     |                                |
                     |                                v
                                                [Judge Worker]

3. THE CLIENT (Standard Web Browser)
--------------------------------------------------------------------------------
*No custom binary required.*
A. User Flow
   1. **Access:** User visits `https://[your-contest].trycloudflare.com`.
   2. **Zero Trust Gate:** Cloudflare Access challenges user (Email OTP / PIN).
   3. **App Login:** Simple password entry (Platform Level).
   4. **Dashboard:**
      - View problems / PDF statements.
      - Upload source code.
      - View "Live Status".

4. THE SERVER APPLICATION (Go HTTPS Server)
--------------------------------------------------------------------------------
A. Authentication Logic
   - *Method:* Persistent Session Cookie.
   - *Storage:* SQLite Table `Sessions` (Token, UserID).
   - *Validity:* Indefinite. Tokens persist across server restarts.
   - *Reset:* Tokens cleared only via Admin CLI command (`--flush-sessions`).
   - *Note:* No CSRF Protection (Accepted Risk).

B. HTTP Endpoints & Reliability
   1. `GET /problems/[id]/pdf`
      - Reads PDF from disk.
      - Serves with `Content-Type: application/pdf`.

   2. `POST /submit/[id]` (Multipart File Upload)
      - **Receive:** Reads uploaded file into memory buffer.
      - **Meta (DB):** Inserts record into `Submissions` (Status: PENDING) *FIRST*.
      - **Storage (Disk):** Saves file to `./storage/submissions/[id].cpp`.
      - **Rollback:** If Disk Write fails, `DELETE` record from `Submissions` immediately.
      - **Enqueue:** Pushes `[ID]` to **Buffered Go Channel**.
      - **Capacity:** Channel size set to **5000**.
        (Size covers Max Users [50] * Max Subs [100] = 100% Guaranteed Non-Blocking).
      - **Response:** Redirects to `/status`.

   3. `GET /status`
      - Queries `Submissions` table.

C. The Judge Worker
   - *Input:* Loops over the Buffered Channel.
   - *Fetch:* Reads file path from DB, loads code from Disk.
   - *Execute:* Runs code in Isolate Sandbox.
   - *Update:* Writes verdict (AC/WA) back to DB.

D. Connectivity & Security
   - *Tunnel:* Cloudflare Tunnel with Zero Trust Access enabled.
   - *Encryption:* End-to-End Encryption.
     - External: Client -> Cloudflare (HTTPS).
     - Internal: Cloudflare -> Go Server (HTTPS via Self-Signed Cert on :8443).
   - *Firewall Compliance:* strictly hosted off-campus to avoid policy violation.

5. DATABASE SCHEMA & CONFIG
--------------------------------------------------------------------------------
* **Configuration:** `PRAGMA journal_mode=WAL;` (Write-Ahead Logging) + `busy_timeout=5000`.

1. Users
   - id, username, password_hash.

2. Sessions
   - token (PK), user_id.

3. Submissions
   - id, user_id, problem_id, status, file_path, created_at.

4. Problems
   - id, letter_code, time_limit, pdf_path.

6. OPERATIONAL POLICIES
--------------------------------------------------------------------------------
* **Submission Cap:** Max 100 submissions per user (checked via DB count).
   - *Note:* Race condition possible (Accepted Risk).

* **Crash Policy:**
   - If the server crashes, the contest is declared **OVER**.
   - No recovery mechanism for the RAM Queue.

* **Orphaned File Prevention (The Reaper):**
   - **Startup Routine:** Server scans `./storage/submissions/` on boot.
   - **Action:** Deletes any file that does not have a corresponding ID in the DB.

* **Weekly Wipe:**
   - **Order:**
     1. Delete all files in `./storage/submissions/`.
     2. Verify deletion.
     3. Wipe DB (clearing hashes/submissions/sessions).
   - *Reasoning:* Prevents DB records from pointing to non-existent files.

7. POST-MVP ARCHITECTURE EXPANSION
--------------------------------------------------------------------------------
A. Identity Model Update
   - **Problem:** Users need to change their team name on the scoreboard without breaking their login credentials.
   - **Solution:** Decouple Authentication from Display.
     - `username`: Immutable, used for Login only.
     - `display_name`: Mutable, used for Scoreboard/Standings. Default = `username`.

B. Polyglot Execution Strategy (Python Support)
   - **Constraint:** Python is interpreted and generally slower than C++.
   - **Execution Path:**
     - *C++:* Compile (`g++`) -> Run Binary.
     - *Python:* No Compile -> Run Interpreter (`python3`) inside Sandbox.

C. Scoreboard Architecture (High Load Protection)
   - **Risk:** Calculating standings (summing penalties/ACs) requires expensive aggregations.
   - **Strategy:** "Read-Through Cache".
     - The Standings Struct is calculated and stored in **RAM**.
     - Cache Time-to-Live (TTL): 30 seconds.
     - Requests hit RAM; DB is only queried if Cache is expired.

D. Static Asset Management
   - **Problem Book:** Instead of dynamic PDF merging, the system serves a static file `all_problems.pdf` manually uploaded by the Admin.
   - **PDF Viewing:** Files are embedded (`<embed>`) directly in the UI to maintain user focus.

E. Test Data & Verification Pipeline (Deterministic)
   - **Concept:** "Baking" instead of dynamic generation.
   - **Components:**
     1. `generator.py`: Accepts an integer argument [SEED]. Prints Input to stdout.
     2. `solution.cpp`: The trusted reference solution. Prints Output to stdout.
   - **The Baking Process (Admin CLI):**
     - Admin provides a **Base Seed**.
     - System loops N times:
       1. Run `generator.py [base_seed + i]` -> Save to `[i].in`.
       2. Run compiled `solution.cpp < [i].in` -> Save to `[i].out`.
   - **Verification:**
     - Worker does NOT run the generator.
     - Worker runs User Code against the pre-baked `.in` files.
     - Output is compared to `.out` using a "Token Diff" (ignoring whitespace).

8. ESSENTIAL CORRECTIONS 
--------------------------------------------------------------------------------
1. Dynamic Limits
   - **Problem:** Worker uses hardcoded 2.0s limit for all problems.
   - **Correction:** Worker must query `problems.time_limit` and pass it to the Sandbox.

2. Compiler Feedback
   - **Problem:** Users receive "CE" verdict but cannot see the error message.
   - **Correction:** - DB: Add `compiler_log` column to `submissions`.
     - Worker: Capture `stderr` from `g++` and save it to DB.
     - UI: Display the log on the Status page if Verdict == CE.

3. Contest Lifecycle
   - **Problem:** Infinite contest time.
   - **Correction:**
     - Enforce `start_time` (Block PDF access before start).
     - Enforce `end_time` (Block submissions after end).

9. CODE STANDARDS & PROJECT STRUCTURE
--------------------------------------------------------------------------------
A. Standard Go Layout (Modular & Scalable)
   The project adopts the Standard Go Layout to ensure modularity, prevent 
   circular dependencies, and clearly separate the application entry point 
   from the private library code.

   Project Root/
   ├── cmd/                     # MAIN APPLICATIONS
   │   └── server/
   │       └── main.go          # Entry Point: Parses CLI flags & starts HTTP server
   │
   ├── internal/                # PRIVATE APPLICATION CODE (Not importable externally)
   │   ├── auth/                # Authentication logic (Session creation, Token generation)
   │   ├── data/                # Data Layer (SQLite connection, Schema, Models, Queries)
   │   ├── engine/              # Judging Core (Submission Queue, Worker, Sandbox, Comparator)
   │   ├── handlers/            # HTTP Transport (Web endpoints, Upload processing, PDF serving)
   │   ├── middleware/          # Request Processing (Auth checks, Context injection)
   │   └── tasks/               # Background Routines (The Reaper, Weekly Wipe, maintenance)
   │
   ├── certs/                   # TLS Certificates (server.crt, server.key)
   ├── templates/               # HTML Frontend Templates
   ├── storage/                 # MUTABLE RUNTIME DATA (Git Ignored)
   │   ├── db/                  # SQLite Database File (WAL mode)
   │   ├── submissions/         # User uploads & compiled binaries
   │   └── problems/            # Problem Data (PDFs, Source, Tests)
   │
   ├── go.mod / go.sum          # Dependencies
   └── README.md                # Documentation

B. File Placement Guidelines (For Future Updates)
   When adding new features, place files according to their technical responsibility:

   1. New Executables or CLI Tools:
      - Place in `cmd/[tool_name]/main.go`.
      - Example: If creating a separate "grader" binary, use `cmd/grader/main.go`.

   2. Core Judging Logic (Phase 8/12):
      - Logic related to running code, diffing outputs, or sandboxing belongs in `internal/engine/`.
      - Example: `comparator.go` (Token Diff) and `python.go` (Interpreter support) go here.

   3. Database Changes:
      - All SQL statements and schema migrations must reside in `internal/data/`.
      - Handlers should call methods from `internal/data` rather than writing raw SQL.

   4. Background Tasks:
      - Maintenance scripts or cron-like jobs belong in `internal/tasks/`.

C. Coding Guidelines
   1. **Dependencies:** Keep lightweight. Prefer `net/http` over heavy frameworks.
   2. **Error Handling:** Log detailed errors internally; return generic HTTP 500 to users.
   3. **Concurrency:** - Use **Channels** for the Submission Queue (Producer/Consumer).
      - Use **Mutexes** for in-memory state (e.g., Scoreboard Cache).
   4. **Database:** Always use Prepared Statements (`?`) to prevent SQL Injection.
   5. **Imports:** Use the `internal/` package to strictly enforce boundary separation.

10. OPERATIONAL SAFEGUARDS
--------------------------------------------------------------------------------
A. Clarification System
   - **Purpose:** Handling ambiguity in problem statements during the contest.
   - **Data Model:** Table `clarifications` (id, user_id, problem_id, question, answer, is_public).
   - **Flow:** 1. User POSTs question.
     2. Admin (via CLI or future UI) updates `answer`.
     3. If `is_public=true`, the Q&A appears on EVERY user's dashboard.

B. The "Broken Problem" Protocol (Discard Policy)
   - **Scenario:** A problem is found to have invalid test data or fatal errors mid-contest.
   - **Policy:** **No Rejudging.** The problem is immediately neutralized to preserve fairness.
   - **Command:** `go run . --discard [problem_id]`
   - **Logic:**
     1. **Hide:** Problem is removed from the Dashboard (Active=False).
     2. **Dump:** All submissions (including ACs) for this ID are DELETE'd from the database.
     3. **Result:** The problem effectively ceases to exist for the scoreboard.

11. UX & STABILITY POLICIES
--------------------------------------------------------------------------------
A. Code History Access
   - **Philosophy:** The server acts as a backup for the user.
   - **Feature:** Read-Only endpoint `GET /submissions/[id]/source`.
   - **Security:** Strict ownership check (User can only view their own code).

B. Granular Verdict Reporting (Codeforces Style)
   - **Goal:** Provide actionable feedback regarding *where* the code failed.
   - **Format:** Status string includes the index of the first failure.
     - Examples: `WA on test 1` [Sample], `TLE on test 25` [Edge Case].
   - **Logic:** Worker loop tracks the iterator index `i` and updates the DB with the specific failure point.

12. ADVANCED JUDGING & CONTEST DYNAMICS
--------------------------------------------------------------------------------
A. Special Judge (Custom Checkers)
   - **Constraint:** "Diff" is insufficient for problems with multiple solutions or floating-point requirements.
   - **Mechanism:**
     - Check for `checker.cpp` in `storage/problems/[id]/`.
     - If exists: Compile `checker`.
     - Execution: `checker [input_file] [user_output] [expected_output]`.
     - Verdict: Checker exit code determines AC (0) or WA (1).

B. Scoreboard Freeze
   - **Purpose:** Maintain suspense during the final phase of the contest.
   - **Logic:**
     - Config: `freeze_time` (timestamp).
     - Public View: Filter submissions where `created_at < freeze_time`.
     - Admin View (CLI): Access to full data to verify winners.
